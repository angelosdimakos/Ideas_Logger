name: Run Tests & CI Audit (optimized)

on:
  push:
    branches: [main, master, "feature/**", "fix/**", "dev/**"]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  statuses: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      venv-path: ${{ steps.venv-setup.outputs.venv-path }}
    steps:
      - uses: actions/checkout@v3

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11.8"
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: üî† Install dependencies
        id: venv-setup
        run: |
          python -m pip install --upgrade pip wheel setuptools virtualenv
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          pip install faiss-cpu --only-binary=faiss-cpu
          echo "venv-path=${GITHUB_WORKSPACE}/.venv" >> "$GITHUB_OUTPUT"

  lint:
    needs: setup
    runs-on: ubuntu-latest
    env: { ZEPHYRUS_HEADLESS: "1" }
    steps:
      - uses: actions/checkout@v3
      - name: ‚úÖ Run linters
        run: |
          source .venv/bin/activate
          mkdir -p lint-reports
          black --check scripts > lint-reports/black.txt 2>&1 || true
          flake8 scripts > lint-reports/flake8.txt 2>&1 || true
          MYPYPATH=. mypy --explicit-package-bases scripts > lint-reports/mypy.txt 2>&1 || true
          pydocstyle scripts > lint-reports/pydocstyle.txt 2>&1 || true
          interrogate -v scripts > lint-reports/interrogate.txt 2>&1 || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports
          path: lint-reports/

  test:
    needs: setup
    runs-on: ubuntu-latest
    env: { ZEPHYRUS_HEADLESS: "1" }
    steps:
      - uses: actions/checkout@v3
      - name: ü•™ Run fast tests
        run: |
          source .venv/bin/activate
          sudo apt-get update && sudo apt-get install -y xvfb
          pip install pytest-xdist
          xvfb-run -a pytest -m "not slow" -n 2 -c pytest.ini \
            --cov=scripts --cov-config=.coveragerc \
            --cov-report=xml --cov-report=html
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: htmlcov
          path: htmlcov/
      - name: ‚òÅÔ∏è Upload to Codecov
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: angelosdimakos/Ideas_Logger
      - name: üß† RefactorGuard audits
        run: |
          source .venv/bin/activate
          python scripts/refactor/refactor_guard_cli.py --refactored scripts --all --missing-tests --json --output refactor_full_audit.json
          python scripts/refactor/refactor_guard_cli.py --refactored scripts --all --git-diff --missing-tests --json --output refactor_diff_audit.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: refactor-audits
          path: |
            refactor_full_audit.json
            refactor_diff_audit.json
      - name: üìã Docstring summary
        run: |
          source .venv/bin/activate
          export PYTHONPATH="$PYTHONPATH:$(pwd)"
          python scripts/refactor/parsers/docstring_parser.py --json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docstring-summary
          path: docstring_summary.json

  report:
    needs: [lint, test]
    runs-on: ubuntu-latest
    if: always()
    env: { ZEPHYRUS_HEADLESS: "1" }
    steps:
      - uses: actions/checkout@v3
      - name: üìÖ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: üß† Enrich audits
        run: |
          source .venv/bin/activate
          python scripts/refactor/enrich_refactor_pkg/enrich_refactor_ci.py --audit artifacts/refactor-audits/refactor_full_audit.json --reports artifacts/lint-reports --docstrings artifacts/docstring-summary/docstring_summary.json
          python scripts/refactor/enrich_refactor_pkg/enrich_refactor_ci.py --audit artifacts/refactor-audits/refactor_diff_audit.json --reports artifacts/lint-reports --docstrings artifacts/docstring-summary/docstring_summary.json
      - name: üìÖ Generate summaries
        run: |
          source .venv/bin/activate
          python scripts/ci_analyzer/cli.py --audit artifacts/refactor-audits/refactor_full_audit.json --output ci_full_summary.md
          python scripts/ci_analyzer/cli.py --audit artifacts/refactor-audits/refactor_diff_audit.json --output ci_diff_summary.md
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-summaries
          path: |
            ci_full_summary.md
            ci_diff_summary.md
      - name: üìä Trend comparison
        run: |
          source .venv/bin/activate
          mkdir -p .ci-history
          python scripts/ci_analyzer/ci_trends.py --audit artifacts/refactor-audits/refactor_full_audit.json
          python scripts/ci_analyzer/ci_trends.py --audit artifacts/refactor-audits/refactor_diff_audit.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-trends-history
          path: .ci-history/
      - name: üìÇ Audit recap
        run: |
          source .venv/bin/activate
          python - <<'PY'
          import json, textwrap
          data = json.load(open('artifacts/refactor-audits/refactor_full_audit.json'))
          files, methods = len(data), sum(len(v.get("complexity", {})) for v in data.values())
          print(textwrap.dedent(f"""
            üìä  Full-audit recap
            ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            üìÇ  Files analysed   : {files}
            üß†  Methods analysed : {methods}
          """).strip())
          PY
      - name: üí¨ Post PR summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: ci_diff_summary.md
