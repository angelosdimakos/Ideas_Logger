name: Run Tests & CI Audit (Dockerized)

on:
  push:
    branches: [main, master, "feature/**", "fix/**", "dev/**"]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  statuses: write
  packages: read

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3

      - name: ðŸ§¼ Run Linter Report CLI
        run: |
          echo "ðŸ”Ž Running Linter Report CLI..."
          python scripts/refactor/lint_report_pkg/lint_report_cli.py --audit linting_report.json  

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: linting_report.json

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    env:
      ZEPHYRUS_HEADLESS: "1"
    steps:
      - uses: actions/checkout@v3

      - name: âœ… Run Tests
        run: |
          echo "ðŸ§ª Running tests with coverage..."
          xvfb-run -a pytest -n auto -c pytest.ini \
            --cov=scripts --cov-config=.coveragerc \
            --cov-report=term --cov-report=html --cov-report=json
          echo "âœ… Coverage reports generated (.coverage, HTML, JSON)"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            .coverage
            coverage.json
            coverage.xml
            htmlcov/

      - name: â˜ï¸ Upload to Codecov
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: angelosdimakos/Ideas_Logger

      - name: ðŸ§  Run RefactorGuard
        run: |
          echo "ðŸ“Š Running RefactorGuard..."
          python scripts/refactor/refactor_guard_cli.py \
            --refactored scripts --all \
            --json --output refactor_audit.json \
            --coverage-path coverage.json # Important: Pass coverage data

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: refactor-audit
          path: refactor_audit.json

  docstring:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3

      - name: ðŸ“‹ Generate Docstring Summary
        run: |
          echo "ðŸ“š Generating docstring summary..."
          python scripts/refactor/parsers/docstring_parser.py --json 

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docstring-summary
          path: docstring_summary.json

  strictness-analysis:
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3

      - name: ðŸ“¥ Download Refactor Audit
        uses: actions/download-artifact@v4
        with:
          name: refactor-audit
          path: ./artifacts/refactor-audit

      - name: ðŸ“ Run Strictness Analyzer
        run: |
          echo "ðŸ“ Running Strictness Analyzer..."
          python scripts/refactor/strictness_analyzer.py \
            --tests tests/unit \
            --source scripts \
            --audit ./artifacts/refactor-audit/refactor_audit.json \
            --output ./artifacts/strictness_mapping.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: strictness-mapping
          path: ./artifacts/strictness_mapping.json

  report:
    needs: [lint, test, docstring]
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: ${{ success() }}
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    env:
      ZEPHYRUS_HEADLESS: "1"
    steps:
      - uses: actions/checkout@v3

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: âœ¨ Generate Combined Report
        run: |
          echo "âš—ï¸ Merging Reports..."
          python scripts/refactor/merge_audit_reports.py \
            --docstrings artifacts/docstring-summary/docstring_summary.json \
            --coverage artifacts/refactor-audit/refactor_audit.json \
            --linting artifacts/lint-report/linting_report.json \
            -o artifacts/merged_report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-report
          path: artifacts/merged_report.json

      - name: ðŸ“Š Generate Severity Audit Report
        run: |
          echo "ðŸ“ˆ Running CI Severity Audit..."
          python scripts/ci_analyzer/severity_audit.py \
            --audit artifacts/merged_report.json \
            --output artifacts/ci_severity_report.md

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-severity-report
          path: artifacts/ci_severity_report.md

      - name: ðŸ’¬ Post PR Summary (Optional)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: artifacts/ci_severity_report.md

  final-report:
    needs: [report, strictness-analysis]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3

      - name: ðŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ðŸ”„ Create Final Report Summary
        run: |
          echo "## CI Quality Analysis Summary" > final_report.md
          echo "" >> final_report.md
          echo "### Test Coverage and Quality Metrics" >> final_report.md
          echo "" >> final_report.md
          
          # Include severity report if available
          if [ -f "./artifacts/ci-severity-report/ci_severity_report.md" ]; then
            cat "./artifacts/ci-severity-report/ci_severity_report.md" >> final_report.md
          fi
          
          echo "" >> final_report.md
          echo "### Test Strictness Analysis" >> final_report.md
          echo "" >> final_report.md
          
          # Include summary from strictness analysis if available
          if [ -f "./artifacts/strictness-mapping/strictness_mapping.json" ]; then
            echo "Test strictness analysis completed successfully. See detailed report in artifacts." >> final_report.md
            echo '```' >> final_report.md
            python -c "import json; data = json.load(open('./artifacts/strictness-mapping/strictness_mapping.json')); print(f\"Total Tests: {data['summary']['total_tests']}\nAvg Strictness: {data['summary']['avg_strictness']}\nAvg Severity: {data['summary']['avg_severity']}\nFiles Covered: {data['summary']['total_prod_files_covered']}\")" >> final_report.md
            echo '```' >> final_report.md
          else
            echo "âš ï¸ Strictness analysis report not available." >> final_report.md
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-report
          path: final_report.md

      - name: ðŸ“„ Post Final Report Summary (Optional)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: final_report.md
          recreate: true