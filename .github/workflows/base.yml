name: Run Tests & CI Audit with Documentation

on:
  push:
    branches: [main, master, "features/**","feature/**", "fix/**", "dev/**"]
  pull_request:
    branches: [main, master,"features/**"]

permissions:
  contents: write
  actions: read
  checks: write
  pull-requests: write
  statuses: write
  packages: read

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3

      - name: ğŸ§¼ Run Linter Report CLI
        run: |
          echo "ğŸ” Running Linter Report CLI..."
          python scripts/refactor/lint_report_pkg/lint_report_cli.py --audit linting_report.json  

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: linting_report.json

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    env:
      ZEPHYRUS_HEADLESS: "1"
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Important: needed to get git history for comparison

      - name: "ğŸ›  Install Runtime Dependency: rapidfuzz"
        run: |
          python -m pip install --no-cache-dir rapidfuzz

      - name: "ğŸ” Detect Changes & Optimize Tests"
        id: optimize-tests
        run: |
          # For pull requests
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            # For push events, compare with parent commit
            BASE_REF="${{ github.event.before }}"
          fi

          echo "Comparing changes between $BASE_REF and ${{ github.sha }}"
          python scripts/ci/optimize_test_job.py --from-ref "$BASE_REF" --to-ref "${{ github.sha }}" --github-output $GITHUB_OUTPUT

      - name: âœ… Run Targeted Tests (Optimized)
        if: ${{ steps.optimize-tests.outputs.run_all == 'false' }}
        run: |
          echo "ğŸ§ª Running targeted tests based on changes..."
          # Save commands to a temporary file to avoid shell escaping issues
          echo '${{ steps.optimize-tests.outputs.test_commands }}' > commands.json
          COUNT=${{ steps.optimize-tests.outputs.command_count }}

          echo "Executing $COUNT test commands"

          # Parse and execute each command using a more robust approach
          for i in $(seq 0 $(($COUNT-1))); do
            # Extract command safely using jq
            COMMAND=$(jq -r ".[$i]" commands.json)
            echo "âš™ï¸ Running test command $(($i+1)) of $COUNT..."
            # Execute the command
            eval "$COMMAND"
          done

          echo "âœ… Targeted tests complete"

      - name: âœ… Run All Tests (Full)
        if: ${{ steps.optimize-tests.outputs.run_all == 'true' }}
        run: |
          echo "ğŸ§ª Running ALL tests with coverage..."
          xvfb-run -a pytest -n auto -c pytest.ini \
            --cov=scripts --cov-config=.coveragerc \
            --cov-report=term --cov-report=html --cov-report=json
          echo "âœ… Coverage reports generated (.coverage, HTML, JSON)"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            .coverage
            coverage.json
            coverage.xml
            htmlcov/

      - name: ğŸ§¹ Strip Empty Coverage Entries
        run: |
          echo "âš”ï¸ Trimming zero-coverage files from coverage.json..."
          python scripts/ci/prune_coverage.py coverage.json cleaned_coverage.json
          mv cleaned_coverage.json coverage.json
          


      - name: â˜ï¸ Upload to Codecov
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          files: ./coverage.json
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: angelosdimakos/Ideas_Logger

      - name: ğŸ§  Run RefactorGuard
        run: |
          echo "ğŸ“Š Running RefactorGuard..."
          python scripts/refactor/refactor_guard_cli.py \
            --refactored scripts --all \
            --json --output refactor_audit.json \
            --coverage-path coverage.json # Important: Pass coverage data

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: refactor-audit
          path: refactor_audit.json

  docstring:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Needed for full git diff comparison

      - name: ğŸ” Detect Changes for Docstring Analysis
        id: optimize-docstring
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
          fi
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "Comparing changes between $BASE_REF and ${{ github.sha }}"
  
          # Use a proper Python script without indentation issues
          CHANGED_FILES=$(python3 -c "import sys; sys.path.insert(0, '.'); from scripts.utils.git_utils import get_added_modified_py_files; files = get_added_modified_py_files('$BASE_REF', '${{ github.sha }}'); print(' '.join(files))")
  
          # Save outputs correctly
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Generate Targeted Docstring Summary
        if: ${{ steps.optimize-docstring.outputs.has_changes == 'true' }}
        run: |
          echo "ğŸ“š Generating docstring summary for changed files..."
          python scripts/refactor/parsers/docstring_parser.py --changed-only --base "${{ steps.optimize-docstring.outputs.base_ref }}" --json

      - name: ğŸ“‹ Generate Full Docstring Summary
        if: ${{ steps.optimize-docstring.outputs.has_changes == 'false' }}
        run: |
          echo "ğŸ“š Generating complete docstring summary..."
          python scripts/refactor/parsers/docstring_parser.py --json

      - name: â˜ï¸ Upload Docstring Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docstring-summary
          path: docstring_summary.json

  strictness-analysis:
    needs: [ test ]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3



      - name: ğŸ“¥ Download Refactor Audit Artifact
        uses: actions/download-artifact@v4
        with:
          name: refactor-audit
          path: ./artifacts/refactor-audit
          merge-multiple: true  # Flatten directory structure to avoid nested folders

      - name: ğŸ“š Run Test Discovery
        run: |
          echo "ğŸ” Running Test Discovery..."
          mkdir -p ./artifacts
          python scripts/refactor/test_discovery.py \
            --tests tests\
            --output ./artifacts/test_report.json

      - name: ğŸ“ Run Strictness Analyzer
        run: |
          echo "ğŸ“ Running Strictness Analyzer with Precomputed Report..."
          python scripts/refactor/strictness_analyzer.py \
            --test-report ./artifacts/test_report.json \
            --audit ./artifacts/refactor-audit/refactor_audit.json \
            --output ./artifacts/final_strictness_report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-strictness-report
          path: ./artifacts/final_strictness_report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-report
          path: ./artifacts/test_report.json

  report:
    needs: [lint, test, docstring]
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: ${{ success() }}
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    env:
      ZEPHYRUS_HEADLESS: "1"
    steps:
      - uses: actions/checkout@v3

      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: âœ¨ Generate Combined Report
        run: |
          echo "âš—ï¸ Merging Reports..."
          python scripts/refactor/merge_audit_reports.py \
            --docstrings artifacts/docstring-summary/docstring_summary.json \
            --coverage artifacts/refactor-audit/refactor_audit.json \
            --linting artifacts/lint-report/linting_report.json \
            -o artifacts/merged_report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: combined-report
          path: artifacts/merged_report.json

      - name: ğŸ“Š Generate Severity Audit Report
        run: |
          echo "ğŸ“ˆ Running CI Severity Audit..."
          python scripts/ci_analyzer/severity_audit.py \
            --audit artifacts/merged_report.json \
            --output artifacts/ci_severity_report.md

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-severity-report
          path: artifacts/ci_severity_report.md

      - name: ğŸ’¬ Post PR Summary (Optional)
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: artifacts/ci_severity_report.md

  documentation:
    needs: [report]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
    container:
      image: ghcr.io/angelosdimakos/ideas_logger:latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“¦ Install MkDocs Dependencies
        run: |
          pip install --no-cache-dir mkdocs-material mkdocstrings mkdocstrings-python

      - name: ğŸ” Generate API Documentation
        run: |
          echo "ğŸ” Running unified docstring doc generator..."
          python scripts/doc_generation/docstring_doc_generation.py \
            --docstrings artifacts/docstring-summary/docstring_summary.json \
            --output docs/api
      

      - name: ğŸ“Š Generate Coverage Page
        run: |
          echo "ğŸ“Š Generating coverage documentation..."
          mkdir -p docs
          python scripts/doc_generation/coverage_doc_generation.py \
            --coverage artifacts/coverage-reports/coverage.json \
            --output docs/coverage

      - name: ğŸ“ˆ Generate Quality Page
        run: |
          echo "ğŸ“ˆ Generating code quality documentation..."
          mkdir -p docs
          python scripts/doc_generation/quality_doc_generation.py \
            --report artifacts/combined-report/merged_report.json \
            --output docs/quality

      - name: ğŸ—ï¸ Build Documentation
        run: |
          echo "ğŸ—ï¸ Building MkDocs site..."
          mkdocs build


      - name: ğŸš€ Deploy Documentation
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site